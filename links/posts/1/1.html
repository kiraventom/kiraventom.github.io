<!DOCTYPE html>
<html lang="en">
<a id="top"></a>
<head>
	<meta charset="UTF-8">
	<title>Брак клавиатуры и low-level hooks</title>
	<style>
		body {
            width: 800px;
            margin: 0 auto;
            font-size: medium;
            text-align: justify;
        }
		
		tiny {
            font-size: xx-small;
			color: #999999;
		}
		
	</style>
</head>
<body>
<p style="font-size: small; text-align: left">
	<a href="..\posts.html">&lt;&lt; к списку постов</a>
</p>
<h2>
	Брак клавиатуры и low-level hooks
</h2>
<p style="color: #888888; font-size: small; text-align: left">
	17.05.2022
</p>
<p>
	В апреле прошлого года я купил себе ноутбук Omen 15.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img style="width: 70%;" 
	src="omen.jpg" alt="Omen">
	<br/>
</p>
<p>
	Примерно через полгода его использования я начал замечать, что с кнопкой 'X/Ч' происходит что-то неладное.
	Время от времени она не реагировала на нажатие с первого раза, а иногда и со второго и с третьего. 
</p>
<p>
	Сначала я, естественно, подумал, что под клавишу что-то попало. Я продул клавишу сжатым воздухом, но проблема не решилась.
	Вуаль загадочности докидывало и нестабильное воспроизведение проблемы. Бывали дни, когда весь день всё работало идеально, 
	а на следующий день сколько ни жми, никакой реакции нет.
	Клавишу я точно ничем не заливал, поэтому я начал гуглить что-то вроде "omen 15 x key".
	<br/>
	И нашёл сабреддит Omen.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img src="reddit.png" alt="Reddit">
	<br/>
	Сабреддит полон жалоб на переставшие работать R и X
</p>
<p>
	Множество людей жаловались, что на их ноутбуке со временем начинали лагать кнопки R и X.
	Внятного решения никто не предлагал, хотя некоторые рассказывали, что они сдали ноутбук по гарантии 
	и проблема решилась.
</p>
<p>
	Правда, другие пользователи уточняли, что так как проблема связана не с самой клавиатурой, а с неким браком материнской платы, 
	ноутбук не ремонтируют, а просто заменяют на другой, более новой сборки. При этом у одного из реддиторов спустя несколько месяцев 
	проблема продолжила воспроизводиться и на новом ноуте.
</p>
<p>
	Гарантия на этот момент у меня всё ещё была активна, но смущало то, что было много жалоб и на некачественный сервис, и на то, 
	что проблема восстанавливается спустя время, и на то, что ноутбук не ремонтируют, а просто заменяют (т.е. надо переносить всю информацию, а так 
	же настраивать всё рабочее окружение, что занимает примерно дня три), а главное -- СЦ держит у себя ноут минимум 2 недели, а обычно около месяца.
</p>
<p>
	Ноут я покупал для того, чтобы я на нём мог работать, и я специально подбирал характеристики так, чтобы он мог компилировать большие солюшены 
	(и не падать при этом в БСОД из-за кончившейся ОЗУ, как предыдущий), поэтому сидеть без ноута несколько недель я не мог. Пришлось оставить надежды на то, 
	что проблему удастся решить напрямую, и начать заниматься главным занятием кодера -- сочинять костыли.
</p>
<p>
	Я решил попробовать написать программу, которая бы ловила нажатие на какую-нибудь не особо нужную клавишу 
	и отправляла нажатие X вместо неё. Благодаря стаковерфлоу и случайно найденному
	 <a href="https://github.com/bramhaag/PopCat-VolumeWindow/blob/master/VolumeKeyListener.cs">репозиторию</a> чувака, который 
	 написал смешную программу с чпокающим котом, я написал код, который при нажатии правого Ctrl должен был имитировать нажатие X.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img src="old x code.png" alt="Old code">
	<br/>
	Если поймали нажатие кнопки и эта кнопка -- правый Ctrl, отправляем 'x'
</p>
<p>
	Всё заработало как я хотел, я добавил иконку в трей, закинул ярлык на exe в папку "Автозагрузка" и пошёл спать.
</p>
<h3 style="margin-top: 500px; text-align: center" >
	SIKE!
</h3>
<p>
	Как всегда, ничего не работает просто. Включив компьютер в следующий раз и нажав правый Ctrl, я обнаружил, 
	что хоть нажатие 'X' и имитируется, но при этом это нажатие не учитывает Shift (т.е., всегда отправляется в нижнем регистре), 
	Ctrl (т.е., хоткей "Вырезать" не работает) и так далее. Я сильно удивился этому, потому как вчера при тестировании всё работало.
	Я запустил студию, начал отлаживать код -- всё работает как надо, на Ctrl и Shift реакция есть. Странно.
</p>
<p>
	Перезагрузил компьютер снова -- проблема вернулась. Выяснилось, что проблема исчезает до следующей перезагрузки, 
	только если заново собрать exe. Умные люди в чате предположили, почему именно это может происходить.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img style="width: 30%;"
	 src="dotnet.png" alt="microsoft">
	<br/>
</p>
<p>
	Затем умный человек в чате предложил использовать 
	<a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-sendinput"><code>SendInput</code></a> 
	вместо <code>SendKeys</code>. Я переписал код следующим образом:
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img src="x code.png" alt="x">
	<br/>
	<code>SendInput</code> вместо <code>SendKeys</code>
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img src="send x code.png" alt="x">
	<br/>
	Метод <code>SendX</code>
</p>
<p>
	Всё заработало как я хотел, я добавил иконку в трей, закинул ярлык на exe в папку "Автозагрузка" и пошёл спать.
</p>
<p style="margin-top: 500px; text-align: center" >
	<img style="width: 10%"
	src="cool.jpg" alt="cool">
</p>
<p>
	Прошёл месяц и у меня начала лагать ещё и кнопка 'R/К'. Я сильно не удивился, потому что на сабреддите 
	R упоминалась даже чаще (возможно, потому, что она в целом чаще используется и это проще заметить). 
	Однако на этот раз проблема заключалась в том, что я не мог придумать клавишу, которую я бы больше совсем не использовал 
	и которую, соответственно, можно было бы использовать под 'R'.
</p>
<p>
	В целом, кандидата было 2 -- правый Alt и кнопка Apps (та, которая открывает контекстное меню). Я решил, что Apps 
	я уж точно никогда не буду использовать и решил поставить хук на неё.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img src="xr code.png" alt="xr">
	<br/>
</p>
<p>
	Однако кнопка Apps отличалась от правого Ctrl -- у многих приложений уже были свои хуки на неё, из-за чего 
	при её нажатии одновременно отправлялась 'R' и открывалось контекстное меню.
</p>
<p>
	Документация достаточно прямолинейна по этому вопросу -- мол, если не хочешь отдавать хук другим программам, 
	не вызывай <code>CallNextHookEx</code> в конце своего коллбэка, а просто возвращай 1 и дело с концом. Так я и сделал.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img src="return 1.png" alt="Return">
	<br/>
</p>
<p>
	ну и тут короче всё заработало я пошёл спать бла-бла-бла как обычно нихера не завелось сходу, контекстное меню всё так же открывается.
</p>
<p style="text-align: center; font-size: small; margin-bottom: 30px" >
	<img style="width: 40%" 
	src="jim.jpg" alt="jim">
	<br/>
</p>
<p style="margin-top: 500px;" >
	В общем, тут я промаялся достаточно долго, пока не понял, что контекстное меню много где привязано не на <code>WM_KEYDOWN</code>, 
	а на <code>WM_KEYUP</code>. Добавил <code>return 1</code> на <code>WM_KEYUP</code> и контекстное меню перестало появляться. Ура?
</p>
<p>
	Почти, потому что в некоторых приложениях (например, VS Code), контекстное меню открывается всё-таки по <code>WM_KEYDOWN</code>, а ещё 
	надо учитывать то, что если приложение поставило свой хук после моих, то его коллбэк будет вызван раньше и контекстное меню всё равно откроется... 
	Я оставил решение этих проблем Алихмену из будущего, а сейчас я просто написал весь этот пост, активно используя RCtrl и Apps, и 
	прекрасно себя чувствую. 
</p>
<p style="margin-top: 300px; font-size: small; text-align: center">
	<a href="..\posts.html">&lt;&lt; к списку постов</a>
	&emsp;
	<a href="#top">^^ наверх</a> 
</p>

</body>
</html>